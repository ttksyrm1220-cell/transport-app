<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>輸送原価・見積額簡易計算（経由地・車種・損益分岐・PDF見積書）</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Meiryo, sans-serif;
      max-width: 820px;
      margin: 20px auto;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
    }
    h1 { font-size: 20px; margin: 6px 0 12px; }
    label { display: block; margin-top: 10px; font-weight: 700; }
    textarea, input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    textarea { min-height: 90px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px){ .row { grid-template-columns: 1fr; } }
    button {
      margin-top: 14px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #bbb;
      background: #fff;
    }
    button.primary { border-color: #333; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result {
      margin-top: 18px;
      padding: 12px;
      border-radius: 8px;
      background: #f7f7f7;
      border: 1px solid #eee;
      line-height: 1.6;
    }
    .legs { margin-top: 10px; font-size: 13px; }
    details {
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      background: #fafafa;
      border: 1px solid #eee;
      font-size: 13px;
      line-height: 1.7;
    }
    details summary { font-weight: 700; cursor: pointer; }

    /* ★PDF用（普段は透明で“存在”させる：画面外へ飛ばさない） */
    #pdfArea {
      position: fixed;
      left: 0;
      top: 0;
      width: 210mm;
      padding: 12mm;
      background: #fff;
      color: #000;

      opacity: 0;           /* 見えない */
      pointer-events: none; /* 触れない */
      z-index: -1;          /* 最背面 */
    }

    .pdf-header { display:flex; justify-content:space-between; align-items:flex-start; gap: 12px; }
    .pdf-title { font-size: 18px; font-weight: 800; margin: 0; }
    .pdf-meta { font-size: 12px; text-align:right; }
    .pdf-box { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px; }
    .pdf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    .pdf-table th, .pdf-table td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    .pdf-table th {
      background: #f2f2f2;
      text-align: left;
      width: 38%;
    }
    .right { text-align: right; }
    .badge-ok { color: #0a7a2f; font-weight: 800; }
    .badge-ng { color: #c41010; font-weight: 800; }
    .muted { color: #666; }
    .small { font-size: 11px; }
  </style>
</head>

<body>
  <h1>輸送原価・見積額 簡易計算（経由地・車種・損益分岐判定・PDF見積書）</h1>

  <details>
    <summary>原価計算の考え方（説明を開く）</summary>
    <p>
      原価は、<strong>原価 ＝ 基本料金（固定費）＋「走行距離 × 1km単価」</strong> で簡易計算します。
    </p>
    <p class="muted small">
      ※ 実務利用時は、貴社の実績（燃料、人件費、車両償却、高速代、間接費等）をもとに数値を更新してください。
    </p>
  </details>

  <div class="row">
    <div>
      <label>見積宛名（PDF用）：</label>
      <input id="customer" type="text" placeholder="例：株式会社〇〇 御中" />
    </div>
    <div>
      <label>件名（PDF用）：</label>
      <input id="subject" type="text" value="輸送見積（概算）" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>作成者/担当（PDF用）：</label>
      <input id="staff" type="text" placeholder="例：営業部 山田" />
    </div>
    <div>
      <label>有効期限（PDF用）：</label>
      <input id="validUntil" type="text" placeholder="例：2026-01-31" />
    </div>
  </div>

  <label>積み地（出発地）住所：</label>
  <input id="origin" type="text" placeholder="例：東京都江東区新木場1-1-1" />

  <label>経由地（任意・複数可、1行に1地点）：</label>
  <textarea id="waypoints" placeholder="例：
埼玉県川口市○○
群馬県高崎市○○
"></textarea>

  <label>卸地（最終到着地）住所：</label>
  <input id="destination" type="text" placeholder="例：大阪府大阪市住之江区1-1-1" />

  <div class="row">
    <div>
      <label>車種：</label>
      <select id="vehicle">
        <option value="4t_wing">4tウイング</option>
        <option value="10t_wing">10tウィング</option>
      </select>
    </div>
    <div>
      <label>見積係数（原価 × 係数）：</label>
      <input id="factor" type="number" step="0.01" value="1.2" placeholder="例：1.2" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>依頼金額（円：任意、判定に使用）：</label>
      <input id="requestAmount" type="number" step="1" placeholder="例：85000" />
    </div>
    <div>
      <label>備考（PDF用）：</label>
      <input id="note" type="text" placeholder="例：高速代別途、待機30分超は別途" />
    </div>
  </div>

  <button class="primary" onclick="calculateRouteAndCost()">原価と見積額を計算</button>
  <button id="pdfBtn" onclick="downloadEstimatePDF()" disabled>見積書PDFを作成</button>

  <div class="result" id="output">ここに結果が表示されます。</div>

  <!-- PDF用の見積書エリア（透明・非操作） -->
  <div id="pdfArea" aria-hidden="true">
    <div class="pdf-header">
      <div>
        <p class="pdf-title">見積書（概算）</p>
        <div class="small muted" id="pdfSubject"></div>
      </div>
      <div class="pdf-meta">
        <div>作成日：<span id="pdfDate"></span></div>
        <div>担当：<span id="pdfStaff"></span></div>
        <div>有効期限：<span id="pdfValid"></span></div>
      </div>
    </div>

    <div class="pdf-box">
      <div style="font-weight:800; font-size: 14px;" id="pdfCustomer"></div>
      <div class="small muted" style="margin-top:4px;">下記の通りお見積り申し上げます。</div>
    </div>

    <div class="pdf-grid">
      <div class="pdf-box">
        <div style="font-weight:800;">運行情報</div>
        <table class="pdf-table">
          <tbody>
            <tr><th>車種</th><td id="pdfVehicle"></td></tr>
            <tr><th>積み地（出発）</th><td id="pdfOrigin"></td></tr>
            <tr><th>卸地（到着）</th><td id="pdfDestination"></td></tr>
            <tr><th>経由地</th><td id="pdfWaypoints"></td></tr>
            <tr><th>総走行距離</th><td id="pdfTotalKm"></td></tr>
          </tbody>
        </table>
      </div>

      <div class="pdf-box">
        <div style="font-weight:800;">金額（目安）</div>
        <table class="pdf-table">
          <tbody>
            <tr><th>見積額（税抜）</th><td class="right" id="pdfEstimate"></td></tr>
            <tr><th>消費税（10%・切り捨て）</th><td class="right" id="pdfTax"></td></tr>
            <tr><th>税込合計</th><td class="right" style="font-weight:900; font-size: 14px;" id="pdfTotalWithTax"></td></tr>
            <tr><th>原価（目安）</th><td class="right" id="pdfCost"></td></tr>
            <tr><th>損益分岐金額（目安）</th><td class="right" id="pdfBreakevenTotal"></td></tr>
            <tr><th>依頼金額（入力時）</th><td class="right" id="pdfRequest"></td></tr>
            <tr><th>判定</th><td id="pdfJudge"></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="pdf-box">
      <div style="font-weight:800;">区間ごとの距離内訳</div>
      <table class="pdf-table">
        <thead>
          <tr><th style="width:auto;">内訳</th></tr>
        </thead>
        <tbody id="pdfLegs"></tbody>
      </table>

      <div class="small muted" style="margin-top:8px;">
        備考：<span id="pdfNote"></span>
      </div>
    </div>

    <div class="small muted" style="margin-top:10px;">
      ※本見積はGoogleの経路情報に基づく概算です。実運行条件（車格規制・高速利用・待機・荷役・迂回等）により変動します。<br>
      ※消費税は外税（10%）とし、税額は1円未満切り捨てで計算しています。<br>
      ※高速代・諸費用の扱いは貴社運用に合わせて備考欄等で調整してください。
    </div>
  </div>

  <!-- html2pdf（日本語の文字化け回避：HTMLをレンダリングしてPDF化） -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- Google Maps API（キーは必ずリファラ制限） -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNNeldUbE5mzfEHdIaaEEudewMm0MPRf4" async defer></script>

  <script>
    // ====== 税設定（外税・切り捨て） ======
    const TAX_RATE = 0.10; // 10%

    // ▼ 車種別 原価パラメータ
    const VEHICLE_PARAMS = {
      "4t_wing":  { label: "4tウイング",  base: 3200, perKm: 130 },
      "10t_wing": { label: "10tウィング", base: 5000, perKm: 190 }
    };

    // ▼ 車種別 損益分岐キロ単価（円/km）
    const BREAKEVEN_KM_RATE = {
      "4t_wing": 135,
      "10t_wing": 197
    };

    let LAST_RESULT = null;

    function yenFloor(n) {
      if (n === null || n === undefined || isNaN(n)) return "";
      return Math.floor(n).toLocaleString("ja-JP") + " 円";
    }
    function kmFmt(n) {
      if (n === null || n === undefined || isNaN(n)) return "";
      return (Math.round(n * 10) / 10).toFixed(1) + " km";
    }
    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function calculateRouteAndCost() {
      const origin = document.getElementById("origin").value.trim();
      const destination = document.getElementById("destination").value.trim();
      const waypointsText = document.getElementById("waypoints").value;
      const vehicleKey = document.getElementById("vehicle").value;
      const factor = parseFloat(document.getElementById("factor").value) || 1.0;

      const requestAmountRaw = document.getElementById("requestAmount").value;
      const requestAmount = requestAmountRaw === "" ? NaN : parseFloat(requestAmountRaw);

      const output = document.getElementById("output");

      if (!origin || !destination) {
        output.innerHTML = "積み地と卸地を入力してください。";
        return;
      }

      const vehicle = VEHICLE_PARAMS[vehicleKey];
      if (!vehicle) {
        output.innerHTML = "車種の設定に問題があります。";
        return;
      }

      const waypointLines = waypointsText
        .split("\n")
        .map(line => line.trim())
        .filter(line => line);

      const waypoints = waypointLines.map(address => ({ location: address, stopover: true }));

      const directionsService = new google.maps.DirectionsService();

      directionsService.route(
        {
          origin,
          destination,
          waypoints,
          optimizeWaypoints: false,
          travelMode: google.maps.TravelMode.DRIVING
        },
        (result, status) => {
          if (status !== "OK") {
            output.innerHTML = "ルート取得に失敗しました：" + status;
            return;
          }

          const route = result.routes[0];
          let totalDistanceMeters = 0;
          let legsHtml = "";

          const legsText = route.legs.map((leg, i) => {
            totalDistanceMeters += leg.distance.value;
            const distKm = leg.distance.value / 1000;
            legsHtml += `区間${i + 1}：${leg.start_address} → ${leg.end_address}：${distKm.toFixed(1)} km<br>`;
            return `区間${i + 1}：${leg.start_address} → ${leg.end_address}：${distKm.toFixed(1)} km`;
          });

          const totalKm = totalDistanceMeters / 1000;

          // 原価 = 固定費 + km単価×距離
          const cost = vehicle.base + totalKm * vehicle.perKm;

          // 見積額（税抜）
          const estimateExTax = cost * factor;

          // 税額（外税・切り捨て）
          const taxAmount = Math.floor(estimateExTax * TAX_RATE);

          // 税込合計
          const totalWithTax = estimateExTax + taxAmount;

          // 損益分岐（固定費込みで整合）
          const breakevenRate = BREAKEVEN_KM_RATE[vehicleKey];
          const breakevenTotal = vehicle.base + breakevenRate * totalKm;

          // 判定（依頼金額 vs 損益分岐金額）
          let judgeHtml = "";
          let diffTotal = null;
          let diffPerKm = null;

          if (!isNaN(requestAmount) && totalKm > 0 && breakevenRate) {
            diffTotal = requestAmount - breakevenTotal;
            diffPerKm = diffTotal / totalKm;

            if (diffTotal >= 0) {
              judgeHtml =
                `<span style="color:green;font-weight:bold;">✅ 黒字見込み</span><br>` +
                `（損益分岐金額 約${Math.floor(breakevenTotal).toLocaleString()}円 に対して、` +
                `依頼金額 ${Math.floor(requestAmount).toLocaleString()}円、<br>` +
                `差額 +${Math.floor(diffTotal).toLocaleString()}円 ≒ +${diffPerKm.toFixed(1)}円/km）<br>`;
            } else {
              judgeHtml =
                `<span style="color:red;font-weight:bold;">❌ 赤字注意</span><br>` +
                `（損益分岐金額 約${Math.floor(breakevenTotal).toLocaleString()}円 に対して、` +
                `依頼金額 ${Math.floor(requestAmount).toLocaleString()}円、<br>` +
                `差額 ${Math.floor(diffTotal).toLocaleString()}円 ≒ ${diffPerKm.toFixed(1)}円/km）<br>`;
            }
          } else {
            judgeHtml = "※ 依頼金額（円）を入力すると、この運行が黒字か赤字かを判定します。<br>";
          }

          // PDF用に保持
          LAST_RESULT = {
            origin,
            destination,
            waypointLines,
            vehicleKey,
            vehicleLabel: vehicle.label,
            factor,
            requestAmount: isNaN(requestAmount) ? null : requestAmount,
            totalKm,
            cost,
            estimateExTax,
            taxAmount,
            totalWithTax,
            breakevenRate,
            breakevenTotal,
            diffTotal,
            diffPerKm,
            legsText,
            note: document.getElementById("note").value.trim(),
            customer: document.getElementById("customer").value.trim(),
            subject: document.getElementById("subject").value.trim(),
            staff: document.getElementById("staff").value.trim(),
            validUntil: document.getElementById("validUntil").value.trim()
          };

          // 画面表示
          output.innerHTML = `
            <strong>車種：</strong>${vehicle.label}<br>
            <strong>総走行距離：</strong>${totalKm.toFixed(1)} km<br><br>

            <strong>損益分岐キロ単価：</strong>${breakevenRate} 円/km<br>
            <strong>損益分岐金額（目安・固定費込み）：</strong>${Math.floor(breakevenTotal).toLocaleString()} 円<br><br>

            <strong>原価（目安）：</strong>${Math.floor(cost).toLocaleString()} 円<br>
            <strong>見積額（税抜：原価 × 係数 ${factor.toFixed(2)}）：</strong>${Math.floor(estimateExTax).toLocaleString()} 円<br>
            <strong>消費税（外税10%・切り捨て）：</strong>${taxAmount.toLocaleString()} 円<br>
            <strong>税込合計：</strong>
              <span style="font-weight:bold;font-size:1.1em;">${Math.floor(totalWithTax).toLocaleString()} 円</span>
            <br><br>

            <strong>依頼金額による判定：</strong><br>
            ${judgeHtml}
            <div class="legs">
              <strong>区間ごとの距離内訳：</strong><br>
              ${legsHtml}
            </div>
          `;

          document.getElementById("pdfBtn").disabled = false;
        }
      );
    }

    function fillPdfTemplate() {
      const r = LAST_RESULT;
      const date = todayStr();

      document.getElementById("pdfDate").textContent = date;
      document.getElementById("pdfCustomer").textContent = r.customer || "（宛名未入力）";
      document.getElementById("pdfSubject").textContent = r.subject ? `件名：${r.subject}` : "件名：輸送見積（概算）";
      document.getElementById("pdfStaff").textContent = r.staff || "（未入力）";
      document.getElementById("pdfValid").textContent = r.validUntil || "（未入力）";

      document.getElementById("pdfVehicle").textContent = r.vehicleLabel;
      document.getElementById("pdfOrigin").textContent = r.origin;
      document.getElementById("pdfDestination").textContent = r.destination;
      document.getElementById("pdfWaypoints").textContent =
        (r.waypointLines && r.waypointLines.length) ? r.waypointLines.join(" / ") : "なし";
      document.getElementById("pdfTotalKm").textContent = kmFmt(r.totalKm);

      document.getElementById("pdfEstimate").textContent = yenFloor(r.estimateExTax);
      document.getElementById("pdfTax").textContent = yenFloor(r.taxAmount);
      document.getElementById("pdfTotalWithTax").textContent = yenFloor(r.totalWithTax);

      document.getElementById("pdfCost").textContent = yenFloor(r.cost);
      document.getElementById("pdfBreakevenTotal").textContent = yenFloor(r.breakevenTotal);
      document.getElementById("pdfRequest").textContent = r.requestAmount != null ? yenFloor(r.requestAmount) : "（未入力）";

      const judgeEl = document.getElementById("pdfJudge");
      if (r.requestAmount == null) {
        judgeEl.innerHTML = `<span class="muted">依頼金額未入力（判定なし）</span>`;
      } else if (r.diffTotal >= 0) {
        judgeEl.innerHTML = `<span class="badge-ok">✅ 黒字見込み</span>
          <div class="small muted">差額 +${Math.floor(r.diffTotal).toLocaleString()}円（+${r.diffPerKm.toFixed(1)}円/km）</div>`;
      } else {
        judgeEl.innerHTML = `<span class="badge-ng">❌ 赤字注意</span>
          <div class="small muted">差額 ${Math.floor(r.diffTotal).toLocaleString()}円（${r.diffPerKm.toFixed(1)}円/km）</div>`;
      }

      const tbody = document.getElementById("pdfLegs");
      tbody.innerHTML = "";
      (r.legsText || []).forEach(t => {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.textContent = t;
        tr.appendChild(td);
        tbody.appendChild(tr);
      });
      if (!r.legsText || r.legsText.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.textContent = "（内訳なし）";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }

      document.getElementById("pdfNote").textContent = r.note || "（なし）";
    }

    // ★白紙対策済みPDF生成（クローンして確実に描画→キャプチャ）
    async function downloadEstimatePDF() {
      if (!LAST_RESULT) {
        alert("先に計算してください。");
        return;
      }

      // 入力欄の最新値を反映
      LAST_RESULT.customer = document.getElementById("customer").value.trim();
      LAST_RESULT.subject = document.getElementById("subject").value.trim();
      LAST_RESULT.staff = document.getElementById("staff").value.trim();
      LAST_RESULT.validUntil = document.getElementById("validUntil").value.trim();
      LAST_RESULT.note = document.getElementById("note").value.trim();

      fillPdfTemplate();

      const original = document.getElementById("pdfArea");
      const clone = original.cloneNode(true);
      clone.id = "pdfAreaClone";

      // クローンを「(0,0)に存在」させる：ユーザーには見せない
      clone.style.position = "fixed";
      clone.style.left = "0";
      clone.style.top = "0";
      clone.style.opacity = "1";
      clone.style.pointerEvents = "none";
      clone.style.zIndex = "9999";
      clone.style.background = "#fff";

      document.body.appendChild(clone);

      // フォント描画待ち
      if (document.fonts && document.fonts.ready) {
        try { await document.fonts.ready; } catch (_) {}
      }
      // 1フレーム待ってDOM反映を確実に
      await new Promise(r => requestAnimationFrame(r));

      const date = todayStr();
      const kmInt = Math.round(LAST_RESULT.totalKm);
      const fileName = `見積書_${date}_${LAST_RESULT.vehicleKey}_${kmInt}km.pdf`;

      const opt = {
        margin:       [6, 6, 6, 6],
        filename:     fileName,
        image:        { type: "jpeg", quality: 0.98 },
        html2canvas:  {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: 0,
          windowWidth: clone.scrollWidth,
          windowHeight: clone.scrollHeight
        },
        jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" },
        pagebreak:    { mode: ["avoid-all", "css", "legacy"] }
      };

      try {
        await html2pdf().set(opt).from(clone).save();
      } finally {
        clone.remove();
      }
    }
  </script>
</body>
</html>
